<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Visor Leaflet M√°laga con GeoJSON</title>

  <!-- Leaflet CSS y JS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- Plugin Geocoder para buscar direcciones -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
  <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>

  <style>
    /* El mapa ocupa toda la ventana del navegador */
    #map { height: 100vh; }
  </style>
</head>
<body>

<div id="map"></div>

<script>
 // 1Ô∏è‚É£ Crear el mapa y centrarlo en M√°laga
 var map = L.map('map').setView([36.7213, -4.4214], 13);

// Crear panes para jerarqu√≠a de capas
map.createPane('paneZBE');
map.createPane('paneZEPCEN');
map.createPane('paneZEPCAC');
map.createPane('paneZEPSOH');
map.createPane('paneSARE');
map.createPane('paneTMMALA');

// Jerarqu√≠a (qui√©n est√° por encima de qui√©n)
map.getPane('paneTMMALA').style.zIndex = 350;
map.getPane('paneZBE').style.zIndex = 400;
map.getPane('paneZEPCEN').style.zIndex = 450;
map.getPane('paneZEPCAC').style.zIndex = 500;
map.getPane('paneZEPSOH').style.zIndex = 550;
map.getPane('paneSARE').style.zIndex = 600;

  // 2Ô∏è‚É£ Capas base

var osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution: '¬© OpenStreetMap contributors',
  maxZoom: 20
});

var satelite = L.tileLayer(
  'https://server.arcgisonline.com/ArcGIS/rest/services/' +
  'World_Imagery/MapServer/tile/{z}/{y}/{x}', {
  attribution: 'Tiles ¬© Esri',
  maxZoom: 20
});

// A√±adir OSM por defecto
osm.addTo(map);

// üîπ Control SOLO mapas base (abajo izquierda)
L.control.layers(
  {
    "üó∫Ô∏è Mapa": osm,
    "üõ∞Ô∏è Sat√©lite": satelite
  },
  null,
  {
    collapsed: true,
    position: 'bottomleft'
  }
).addTo(map);

  // 3Ô∏è‚É£ A√±adir buscador de direcciones
  L.Control.geocoder({ defaultMarkGeocode: true }).addTo(map);

// üëâ Funci√≥n para etiqueta con simbolog√≠a
function etiqueta(color, texto) {
    return `
      <span style="display:inline-flex; align-items:center;">
        <span style="
          width:14px;
          height:14px;
          background:${color};
          opacity:0.4;
          border:2px solid ${color};
          margin-right:6px;">
        </span>
        ${texto}
      </span>
    `;
  }

var capasGeoJSON = {};

// 4Ô∏è‚É£ Cargar todas las capas GeoJSON y luego crear el control independiente
  Promise.all([
    fetch('zbe.geojson').then(r => r.json()),
    fetch('zepcen.geojson').then(r => r.json()),
    fetch('zepcac.geojson').then(r => r.json()),
    fetch('zepsoh.geojson').then(r => r.json()),
    fetch('SARE.geojson').then(r => r.json()),
  fetch('tmmala.geojson').then(r => r.json()),
  ]).then(([zbe, zepcen, zepcac, zepsoh, sare, tmmala]) => {

 // Funci√≥n para aplicar los eventos de cada capa
    function aplicarEventos(layer, nombre) {
      layer.on('mouseover', function () {
        layer.setStyle({ weight: 4, fillOpacity: 0.45 });
        layer.bringToFront();
      });
      layer.on('mouseout', function () {
        layer.setStyle({ weight: 2, fillOpacity: 0.3 });
      });
      layer.on('click', function () { layer.bringToFront(); });
      layer.bindPopup(nombre);
    }

    // ZBE
    var capaZBE = L.geoJSON(zbe, {
      pane: 'paneZBE',
      style: { color: '#0000ff', weight: 2, fillOpacity: 0.3 },
      onEachFeature: (f, l) => aplicarEventos(l, f.properties?.NOMBRE || 'Zona de Bajas Emisiones')
    }).addTo(map);
    capasGeoJSON[etiqueta('#0000ff', 'Zona de Bajas Emisiones')] = capaZBE;

    // ZEP Centro
    var capaZEPCEN = L.geoJSON(zepcen, {
      pane: 'paneZEPCEN',
      style: { color: '#dc3b2c', weight: 2, fillOpacity: 0.3 },
      onEachFeature: (f, l) => aplicarEventos(l, f.properties?.NOMBRE || 'Zona de Especial Protecci√≥n Centro')
    }).addTo(map);
    capasGeoJSON[etiqueta('#dc3b2c', 'Zona de Especial Protecci√≥n Centro')] = capaZEPCEN;

    // ZEP CAC
    var capaZEPCAC = L.geoJSON(zepcac, {
      pane: 'paneZEPCAC',
      style: { color: '#811c45', weight: 2, fillOpacity: 0.3 },
      onEachFeature: (f, l) => aplicarEventos(l, f.properties?.NOMBRE || 'Zona de Especial Protecci√≥n CAC')
    }).addTo(map);
    capasGeoJSON[etiqueta('#811c45', 'Zona de Especial Protecci√≥n CAC')] = capaZEPCAC;

    // ZEP SOHO
    var capaZEPSOH = L.geoJSON(zepsoh, {
      pane: 'paneZEPSOH',
      style: { color: '#dd4f88', weight: 2, fillOpacity: 0.3 },
      onEachFeature: (f, l) => aplicarEventos(l, f.properties?.NOMBRE || 'Zona de Especial Protecci√≥n SOHO')
    }).addTo(map);
    capasGeoJSON[etiqueta('#dd4f88', 'Zona de Especial Protecci√≥n SOHO')] = capaZEPSOH;

    // SARE
    var capaSARE = L.geoJSON(sare, {
      pane: 'paneSARE',
      style: { color: '#6673E5', weight: 2, fillOpacity: 0.3 },
      onEachFeature: (f, l) => aplicarEventos(l, f.properties?.NOMBRE || 'SARE')
    }).addTo(map);
    capasGeoJSON[etiqueta('#6673E5', 'SARE')] = capaSARE;

    // TMMALA
    var capaTMMALA = L.geoJSON(tmmala, { 
      pane: 'paneTMMALA', 
      style: { 
      color: '#c25e6d', 
      weight: 2, 
      fillOpacity: 0.2 
  },
  onEachFeature: function (f, layer) {
    layer.bindPopup(f.properties?.NOMBRE || 'T√©rmino Municipal de M√°laga');
  }
     }).addTo(map); 
     capasGeoJSON[etiqueta('#c25e6d', 'T√©rmino Municipal de M√°laga')] = capaTMMALA;   

    // üîπ Crear control de capas GeoJSON independiente (topright)
    L.control.layers(null, capasGeoJSON, {
      collapsed: false,
      position: 'topright'
    }).addTo(map);

  });

</script>

</body>
</html>

