<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Visor Leaflet M√°laga con GeoJSON</title>

  <!-- Leaflet CSS y JS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- Plugin Geocoder para buscar direcciones -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
  <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>

  <style>
    /* El mapa ocupa toda la ventana del navegador */
    #map { height: 100vh; }
  </style>
</head>
<body>

<div id="map"></div>

<script>
  // 1Ô∏è‚É£ Crear el mapa y centrarlo en M√°laga
  var map = L.map('map').setView([36.7213, -4.4214], 13);

// Crear panes para jerarqu√≠a de capas
map.createPane('paneZBE');
map.createPane('paneZEPCEN');
map.createPane('paneZEPCAC');
map.createPane('paneZEPSOH');
map.createPane('paneSARE');

// Jerarqu√≠a (qui√©n est√° por encima de qui√©n)
map.getPane('paneZBE').style.zIndex = 400;
map.getPane('paneZEPCEN').style.zIndex = 450;
map.getPane('paneZEPCAC').style.zIndex = 500;
map.getPane('paneZEPSOH').style.zIndex = 550;
map.getPane('paneSARE').style.zIndex = 600;

  // 2Ô∏è‚É£ A√±adir capa base OpenStreetMap
var osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution: '¬© OpenStreetMap contributors'
});

var satelite = L.tileLayer(
  'https://server.arcgisonline.com/ArcGIS/rest/services/' +
  'World_Imagery/MapServer/tile/{z}/{y}/{x}', {
  attribution: 'Tiles ¬© Esri'
});

// A√±adir OSM por defecto
osm.addTo(map); 

  // 3Ô∏è‚É£ A√±adir buscador de direcciones
  L.Control.geocoder({ defaultMarkGeocode: true }).addTo(map);

// üëâ Funci√≥n para etiqueta con simbolog√≠a
function etiqueta(color, texto) {
    return `
      <span style="display:inline-flex; align-items:center;">
        <span style="
          width:14px;
          height:14px;
          background:${color};
          opacity:0.4;
          border:2px solid ${color};
          margin-right:6px;">
        </span>
        ${texto}
      </span>
    `;
  }

var capasGeoJSON = {};

  // 4Ô∏è‚É£ Cargar y mostrar GeoJSON

 // ZBE
  fetch('zbe.geojson')
    .then(r => r.json())
    .then(data => {
      capasGeoJSON[
        etiqueta('#0000ff', 'Zona de Bajas Emisiones')
      ] = L.geoJSON(data, {
        pane: 'paneZBE',
	    style: {
          color: '#0000ff',
          weight: 2,
          fillOpacity: 0.3
        },
  	  onEachFeature: function (feature, layer) {

 	  // üëâ Resaltar al pasar el cursor
        layer.on('mouseover', function () {
          layer.setStyle({
            weight: 4,
            fillOpacity: 0.45
          });
          layer.bringToFront();
        });

        // üëâ Volver al estilo original al salir
        layer.on('mouseout', function () {
          layer.setStyle({
            weight: 2,
            fillOpacity: 0.3
          });
        });

        // üëâ Traer la capa al frente al hacer click
        layer.on('click', function () {
          layer.bringToFront();
        });

        // üëâ Popup correcto
        layer.bindPopup(
          feature.properties?.NOMBRE || 'Zona de Bajas Emisiones'
        );
      }
    }).addTo(map);

    crearControl();
  });       

  // ZEP Centro
  fetch('zepcen.geojson')
    .then(r => r.json())
    .then(data => {
      capasGeoJSON[
        etiqueta('#dc3b2c', 'Zona de Especial Protecci√≥n Centro')
      ] = L.geoJSON(data, {
	pane: 'paneZEPCEN',
        style: {
          color: '#dc3b2c',
          weight: 2,
          fillOpacity: 0.3
        },
        onEachFeature: function (feature, layer) {

 	  // üëâ Resaltar al pasar el cursor
        layer.on('mouseover', function () {
          layer.setStyle({
            weight: 4,
            fillOpacity: 0.45
          });
          layer.bringToFront();
        });

        // üëâ Volver al estilo original al salir
        layer.on('mouseout', function () {
          layer.setStyle({
            weight: 2,
            fillOpacity: 0.3
          });
        });

        // üëâ Traer la capa al frente al hacer click
        layer.on('click', function () {
          layer.bringToFront();
        });

        // üëâ Popup correcto
        layer.bindPopup(
          feature.properties?.NOMBRE || 'Zona de Especial Protecci√≥n Centro'
        );
      }
    }).addTo(map);

    crearControl();
  });

  // ZEP CAC
  fetch('zepcac.geojson')
    .then(r => r.json())
    .then(data => {
      capasGeoJSON[
        etiqueta('#811c45', 'Zona de Especial Protecci√≥n CAC')
      ] = L.geoJSON(data, {
	pane: 'paneZEPCAC',
        style: {
          color: '#811c45',
          weight: 2,
          fillOpacity: 0.3
        },
         onEachFeature: function (feature, layer) {

 	  // üëâ Resaltar al pasar el cursor
        layer.on('mouseover', function () {
          layer.setStyle({
            weight: 4,
            fillOpacity: 0.45
          });
          layer.bringToFront();
        });

        // üëâ Volver al estilo original al salir
        layer.on('mouseout', function () {
          layer.setStyle({
            weight: 2,
            fillOpacity: 0.3
          });
        });

        // üëâ Traer la capa al frente al hacer click
        layer.on('click', function () {
          layer.bringToFront();
        });

        // üëâ Popup correcto
        layer.bindPopup(
          feature.properties?.NOMBRE || 'Zona de Especial Protecci√≥n CAC'
        );
      }
    }).addTo(map);

    crearControl();
  });

  // ZEP SOHO
  fetch('zepsoh.geojson')
    .then(r => r.json())
    .then(data => {
      capasGeoJSON[
        etiqueta('#dd4f88', 'Zona de Especial Protecci√≥n SOHO')
      ] = L.geoJSON(data, {
	pane: 'paneZEPSOH',
        style: {
          color: '#dd4f88',
          weight: 2,
          fillOpacity: 0.3
        },
         onEachFeature: function (feature, layer) {

 	  // üëâ Resaltar al pasar el cursor
        layer.on('mouseover', function () {
          layer.setStyle({
            weight: 4,
            fillOpacity: 0.45
          });
          layer.bringToFront();
        });

        // üëâ Volver al estilo original al salir
        layer.on('mouseout', function () {
          layer.setStyle({
            weight: 2,
            fillOpacity: 0.3
          });
        });

        // üëâ Traer la capa al frente al hacer click
        layer.on('click', function () {
          layer.bringToFront();
        });

        // üëâ Popup correcto
        layer.bindPopup(
          feature.properties?.NOMBRE || 'Zona de Especial Protecci√≥n SOHO'
        );
      }
    }).addTo(map);

    crearControl();
  });

  // SARE
  fetch('SARE.geojson')
    .then(r => r.json())
    .then(data => {
      capasGeoJSON[
        etiqueta('#6673E5', 'SARE')
      ] = L.geoJSON(data, {
	pane: 'paneSARE',
        style: {
          color: '#6673E5',
          weight: 2,
          fillOpacity: 0.3
        },
         onEachFeature: function (feature, layer) {

 	  // üëâ Resaltar al pasar el cursor
        layer.on('mouseover', function () {
          layer.setStyle({
            weight: 4,
            fillOpacity: 0.45
          });
          layer.bringToFront();
        });

        // üëâ Volver al estilo original al salir
        layer.on('mouseout', function () {
          layer.setStyle({
            weight: 2,
            fillOpacity: 0.3
          });
        });

        // üëâ Traer la capa al frente al hacer click
        layer.on('click', function () {
          layer.bringToFront();
        });

        // üëâ Popup correcto
        layer.bindPopup(
          feature.properties?.NOMBRE || 'Zona de Especial Protecci√≥n CAC'
        );
      }
    }).addTo(map);

    crearControl();
  });

// Control de capas (se rehace cada vez)
var controlCapas;

function crearControl() {

  if (controlCapas) {
    controlCapas.remove();
  }

  var capasBase = {
    "üó∫Ô∏è Mapa": osm,
    "üõ∞Ô∏è Sat√©lite": satelite
  };

  controlCapas = L.control.layers(capasBase, capasGeoJSON, {
    collapsed: false
  }).addTo(map);
}


</script>

</body>
</html>  


