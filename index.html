<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Visor Leaflet M谩laga con GeoJSON</title>

  <!-- Leaflet CSS y JS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- Plugin Geocoder para buscar direcciones -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
  <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>

  <style>
    /* El mapa ocupa toda la ventana del navegador */
    #map { height: 100vh; }
  </style>
</head>
<body>

<div id="map"></div>

<script>
  // 1锔 Crear el mapa y centrarlo en M谩laga
  var map = L.map('map').setView([36.7213, -4.4214], 13);

  // 2锔 A帽adir capa base OpenStreetMap
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '漏 OpenStreetMap'
  }).addTo(map);

  // 3锔 A帽adir buscador de direcciones
  L.Control.geocoder({ defaultMarkGeocode: true }).addTo(map);

//  Funci贸n para etiqueta con simbolog铆a
function etiqueta(color, texto) {
    return `
      <span style="display:inline-flex; align-items:center;">
        <span style="
          width:14px;
          height:14px;
          background:${color};
          opacity:0.4;
          border:2px solid ${color};
          margin-right:6px;">
        </span>
        ${texto}
      </span>
    `;
  }

var capasGeoJSON = {};

  // 4锔 Cargar y mostrar GeoJSON

 // ZBE
  fetch('zbe.geojson')
    .then(r => r.json())
    .then(data => {
      capasGeoJSON[
        etiqueta('#0000ff', 'Zona de Bajas Emisiones')
      ] = L.geoJSON(data, {
        style: {
          color: '#0000ff',
          weight: 2,
          fillOpacity: 0.3
        },
        onEachFeature: (f, l) =>
          l.bindPopup(f.properties?.NOMBRE || 'Zona de Bajas Emisiones')
      }).addTo(map);

      crearControl();
    });

  // ZEP Centro
  fetch('zepcen.geojson')
    .then(r => r.json())
    .then(data => {
      capasGeoJSON[
        etiqueta('#dc3b2c', 'Zona de Especial Protecci贸n Centro')
      ] = L.geoJSON(data, {
        style: {
          color: '#dc3b2c',
          weight: 2,
          fillOpacity: 0.3
        },
        onEachFeature: (f, l) =>
          l.bindPopup(f.properties?.NOMBRE || 'Zona de Especial Protecci贸n Centro')
      }).addTo(map);

      crearControl();
    });

  // ZEP CAC
  fetch('zepcac.geojson')
    .then(r => r.json())
    .then(data => {
      capasGeoJSON[
        etiqueta('#811c45', 'Zona de Especial Protecci贸n CAC')
      ] = L.geoJSON(data, {
        style: {
          color: '#811c45',
          weight: 2,
          fillOpacity: 0.3
        },
        onEachFeature: (f, l) =>
          l.bindPopup(f.properties?.NOMBRE || 'Zona de Especial Protecci贸n CAC')
      }).addTo(map);

      crearControl();
    });

  // ZEP SOHO
  fetch('zepsoh.geojson')
    .then(r => r.json())
    .then(data => {
      capasGeoJSON[
        etiqueta('#dd4f88', 'Zona de Especial Protecci贸n SOHO')
      ] = L.geoJSON(data, {
        style: {
          color: '#dd4f88',
          weight: 2,
          fillOpacity: 0.3
        },
        onEachFeature: (f, l) =>
          l.bindPopup(f.properties?.NOMBRE || 'Zona de Especial Protecci贸n SOHO')
      }).addTo(map);

      crearControl();
    });

  // SARE
  fetch('SARE.geojson')
    .then(r => r.json())
    .then(data => {
      capasGeoJSON[
        etiqueta('#6673E5', 'SARE')
      ] = L.geoJSON(data, {
        style: {
          color: '#6673E5',
          weight: 2,
          fillOpacity: 0.3
        },
        onEachFeature: (f, l) =>
          l.bindPopup(f.properties?.NOMBRE || 'SARE')
      }).addTo(map);

      crearControl();
    });

  // Control de capas (se rehace cada vez)
  var controlCapas;
  function crearControl() {
    if (controlCapas) {
      controlCapas.remove();
    }
    controlCapas = L.control.layers(null, capasGeoJSON, {
      collapsed: false
    }).addTo(map);
  }
</script>

</body>
</html>
